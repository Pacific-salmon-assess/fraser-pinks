---
title: "Fraser pinks"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    collapsed: no
    fig_caption: yes
    highlight: espresso
    number_sections: yes
    smooth_scroll: yes
    theme: sandstone
    toc: yes
    toc_float: yes
    keep_md: true
---

```{=html}
<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 13px;
}
h1.title {
  font-size: 24px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 19px;
  color: Black;
}
h2 { /* Header 2 */
    font-size: 15px;
  color: Black;
}
</style>
```

```{r setup, include=FALSE}
# Settings and libraries
knitr::opts_chunk$set(echo = FALSE, message=FALSE, cache=FALSE, include=TRUE)
knitr::opts_chunk$set(dpi=300)

library(rstan)
library(tidyverse)
library(kableExtra)

options(scipen=1, digits=4)

# Read in data and posterior samples
data <- read.csv("../data/fr_pk_spw_har.csv")
stan.fit <- readRDS("../analysis/output/SS-SR_AR1.stan.fit.rds")
stan.data <- readRDS("../analysis/output/SS-SR_AR1.stan.data.rds")
model_pars <- rstan::extract(stan.fit)

```
# Background
Preliminary exploration of Fraser pink salmon spawner-recruitment relationship and associated biological benchmarks. 

# Data and model formualtion
First, a quick look at the raw escapement and harvest time series.  

```{r escape time series, caption = "Figure 1"}
escape_harvest <- gather(data[,1:3], type, count, harvest:spawn, factor_key=TRUE)

ggplot(escape_harvest, aes(fill=type, y=count/1000000, x=year)) + 
    geom_bar(position="stack", stat="identity") +
    scale_fill_brewer(palette="Dark2",name = "") +
    xlab("Year") +
    ylab("Millions of fish") +
    theme_bw()

```

Note spawning escapement has been estimated with various methods over the years which vary in their precision and all o which are likely less precise than estimates of harvest. We would like to account for this time varying observation error when estimating the shape of the spawner-recruitment relationship. To do this we fit a state-space spawner recruitment model to the estimates of spawner abundance and harvest. The model is similar to the one originally described in [Fleischman et al. 2013](https://cdnsciencepub.com/doi/full/10.1139/cjfas-2012-0112) but without age-structure given the fixed two-year pink salmon life cycle. The model assumed a Ricker type spawner-recruitment relationship with serially correlated recruitment residuals and was parameterized with a log-normal bias correction applied directly to the likelihood for the process model. The observation error CVs on escapement specified for the observation model, which are just place holders for now, were: 

```{r}
Years <- c("1957-1985 ", "1987-1991", "1993-2001", "2003-2007", "2009-2011", "2013-2021")
Method <- c("PSC mark-recapture (system specific)", "DFO mark-recapture (system specific)", "DFO mark-recapture (mainstem)", "test fishery", "Mission post-season", "Mission in-season")
CV <- c("20%", "20%", "20%", "50%", "35%", "35%")

df <- data.frame(Years, Method, CV)

kable(data.frame(df), align="crr") %>% #digits=c(1) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```
We assumed a 5% CV on harvest for all year (again as a placeholder).

We fit the spawner-recruitment model in the [Stan Bayesian modelling platform](https://mc-stan.org/), using the [rstan](https://mc-stan.org/rstan/index.html) package. More details on model structure, priors, etc. can be found in the `analysis` sub-folder of [this repository](https://github.com/Pacific-salmon-assess/fraser-pinks) 

# Data and model formualtion

```{r , include = FALSE}
# Settings and libraries

knitr::opts_chunk$set(echo = FALSE, message=FALSE, cache=FALSE, include=TRUE)
knitr::opts_chunk$set(dpi=300)

options(scipen=1, digits=4)

# Read in Model Data and Output Files for each of the three models (base/body count, total eggs and total egg mass versions)


```

based on fitting state-space spawner recruitment models to observations of Fraser River pink salmon spawning escapement and harvest. 
